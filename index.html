<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IKIZULIVE</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#e9ecef;
}

.wrapper{
  display:flex;
  height:100vh;
}

.left{
  width:260px;
  background:#f1f1f1;
  padding:20px;
  border-right:1px solid #ccc;
}

.left textarea{
  width:100%;
  margin-bottom:10px;
}

.left button{
  background:black;
  color:white;
  border:none;
  padding:8px 12px;
  cursor:pointer;
}

.center{
  flex:1;
  padding:30px;
  overflow-y:auto;
}

.post-card{
  background:white;
  padding:20px;
  border-radius:14px;
  margin-bottom:30px;
}

.post-card blockquote{
  margin-bottom:20px;
}

.post-actions{
  margin-top:15px;
}

.btn-dark{
  background:black;
  color:white;
  border:none;
  padding:6px 12px;
  margin-right:5px;
  cursor:pointer;
}

.btn-danger{
  background:#dc3545;
  color:white;
  border:none;
  padding:6px 12px;
  cursor:pointer;
}

.right{
  width:260px;
  background:#f8f9fa;
  padding:20px;
  border-left:1px solid #ccc;
}

.timeline-btn{
  display:block;
  width:100%;
  margin-bottom:10px;
  background:#333;
  color:white;
  border:none;
  padding:10px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="wrapper">

<div class="left">
<h2>IKIZULIVE</h2>

<h4>เพิ่มหลายโพสต์ในกล่องเดียว</h4>
<textarea id="linkInput" rows="8" placeholder="1 บรรทัด = 1 ลิงก์"></textarea>

<textarea id="translateInput" rows="5" placeholder="คำแปลรวม"></textarea>

<button id="addBtn">เพิ่มโพสต์</button>
</div>

<div class="center">
<div id="posts"></div>
</div>

<div class="right">
<h3>Timeline</h3>
<button class="timeline-btn" id="showAllBtn">แสดงทั้งหมด</button>
<div id="timelineButtons"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= CONFIG ================= */

const firebaseConfig = {
  apiKey: "AIzaSyDlybmqJBVyC2B3Kh09KfbsO0XvH5Md2Vo",
  authDomain: "ikizuliveth.firebaseapp.com",
  projectId: "ikizuliveth",
  storageBucket: "ikizuliveth.firebasestorage.app",
  messagingSenderId: "435466293836",
  appId: "1:435466293836:web:15c46e9be1b484c91b9ae9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const postsRef = collection(db, "posts");

/* ================= STATE ================= */

let allPosts = [];
let monthMap = {};

/* ================= DOM ================= */

const postsContainer = document.getElementById("posts");
const timelineContainer = document.getElementById("timelineButtons");
const addBtn = document.getElementById("addBtn");
const showAllBtn = document.getElementById("showAllBtn");
const linkInput = document.getElementById("linkInput");
const translateInput = document.getElementById("translateInput");

/* ================= UTIL ================= */

function extractTweetId(link){
  const match = link.match(/status\/(\d+)/);
  return match ? match[1] : null;
}

function getDateFromTweetId(id){
  const twitterEpoch = 1288834974657n;
  const timestamp = (BigInt(id) >> 22n) + twitterEpoch;
  return new Date(Number(timestamp));
}

function escapeHTML(str){
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}

/* ================= RENDER ================= */

function render(posts){
  postsContainer.innerHTML = "";
  posts.forEach(createPostCard);
  if(window.twttr) window.twttr.widgets.load();
}

function createPostCard(post){
  const card = document.createElement("div");
  card.className = "post-card";

  post.postIds.forEach(id=>{
    const block = document.createElement("blockquote");
    block.className = "twitter-tweet";
    block.innerHTML = `<a href="https://twitter.com/i/status/${id}"></a>`;
    card.appendChild(block);
  });

  const actions = document.createElement("div");
  actions.className = "post-actions";

  const toggleBtn = document.createElement("button");
  toggleBtn.className = "btn-dark";
  toggleBtn.textContent = "ดูคำแปล";
  toggleBtn.addEventListener("click", ()=>{
    translateEl.style.display =
      translateEl.style.display === "none" ? "block" : "none";
  });

  const deleteBtn = document.createElement("button");
  deleteBtn.className = "btn-danger";
  deleteBtn.textContent = "ลบ";
  deleteBtn.addEventListener("click", async ()=>{
    await deleteDoc(doc(db, "posts", post.id));
  });

  actions.appendChild(toggleBtn);
  actions.appendChild(deleteBtn);

  const translateEl = document.createElement("p");
  translateEl.style.display = "none";
  translateEl.style.marginTop = "10px";
  translateEl.innerHTML = escapeHTML(post.content);

  card.appendChild(actions);
  card.appendChild(translateEl);

  postsContainer.appendChild(card);
}

/* ================= ADD POSTS ================= */

async function addPosts(){
  const lines = linkInput.value.split("\n");
  const translate = translateInput.value.trim();

  const postIds = [];
  let earliestDate = null;

  for(const line of lines){
    const id = extractTweetId(line.trim());
    if(!id) continue;

    postIds.push(id);

    const date = getDateFromTweetId(id);
    if(!earliestDate || date < earliestDate){
      earliestDate = date;
    }
  }

  if(postIds.length === 0) return;

  await addDoc(postsRef,{
    postIds,
    content: translate,
    createdAt: Timestamp.fromDate(earliestDate)
  });

  linkInput.value = "";
  translateInput.value = "";
}

/* ================= TIMELINE ================= */

function buildTimeline(){
  timelineContainer.innerHTML = "";

  Object.keys(monthMap)
    .sort((a,b)=>{
      const [m1,y1]=a.split("-");
      const [m2,y2]=b.split("-");
      return new Date(y1,m1-1)-new Date(y2,m2-1);
    })
    .forEach(key=>{
      const [m,y] = key.split("-");
      const btn = document.createElement("button");
      btn.className = "timeline-btn";
      btn.textContent = `เดือนที่ ${m} ปี ${y}`;
      btn.addEventListener("click", ()=>{
        render(monthMap[key]);
      });
      timelineContainer.appendChild(btn);
    });
}

/* ================= FIRESTORE LISTENER ================= */

const q = query(postsRef, orderBy("createdAt","asc"));

onSnapshot(q,(snapshot)=>{
  allPosts = [];
  monthMap = {};

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    if(!data.createdAt) return;

    const date = data.createdAt.toDate();
    const month = date.getMonth()+1;
    const year = date.getFullYear();
    const key = `${month}-${year}`;

    const post = { id: docSnap.id, ...data };
    allPosts.push(post);

    if(!monthMap[key]) monthMap[key] = [];
    monthMap[key].push(post);
  });

  buildTimeline();
  render(allPosts);
});

/* ================= EVENTS ================= */

addBtn.addEventListener("click", addPosts);
showAllBtn.addEventListener("click", ()=> render(allPosts));

</script>

<script async src="https://platform.twitter.com/widgets.js"></script>

</body>
</html>
