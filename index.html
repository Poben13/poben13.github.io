<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Posts</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDlybmqJBVyC2B3Kh09KfbsO0XvH5Md2Vo",
      authDomain: "ikizuliveth.firebaseapp.com",
      projectId: "ikizuliveth",
      storageBucket: "ikizuliveth.firebasestorage.app",
      messagingSenderId: "435466293836",
      appId: "1:435466293836:web:15c46e9be1b484c91b9ae9",
      measurementId: "G-XWHC2XZ6H8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const postsRef = collection(db, "posts");

    function renderPosts(snapshot) {
      const container = document.getElementById("posts");
      const timeline = document.getElementById("timeline");
      container.innerHTML = "";
      timeline.innerHTML = "";

      let monthMap = {};

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const date = data.createdAt.toDate();
        const monthYear = `${date.getMonth()+1}-${date.getFullYear()}`;

        if (!monthMap[monthYear]) {
          monthMap[monthYear] = [];
        }

        monthMap[monthYear].push({ id: docSnap.id, ...data });
      });

      Object.keys(monthMap).forEach(key => {
        const [month, year] = key.split("-");
        const btn = document.createElement("button");
        btn.innerText = `เดือนที่ ${month} ปี ${year}`;
        btn.onclick = () => {
          container.innerHTML = "";
          monthMap[key].forEach(post => {
            createPostElement(post);
          });
        };
        timeline.appendChild(btn);
      });

      snapshot.forEach(docSnap => {
        createPostElement({ id: docSnap.id, ...docSnap.data() });
      });
    }

    function createPostElement(post) {
      const container = document.getElementById("posts");

      const div = document.createElement("div");
      div.className = "post";

      div.innerHTML = `
        <iframe src="https://platform.twitter.com/embed/Tweet.html?id=${post.postId}" width="100%" height="600"></iframe>
        <p>${post.content}</p>
        <button onclick="window.deletePost('${post.id}')">ลบโพสต์</button>
        <hr>
      `;

      container.appendChild(div);
    }

    window.deletePost = async (id) => {
      await deleteDoc(doc(db, "posts", id));
    };

    window.addPosts = async () => {
      const raw = document.getElementById("bulkInput").value;
      const lines = raw.split("\n");

      for (let line of lines) {
        if (!line.trim()) continue;

        const [postId, content, dateStr] = line.split("|");

        await addDoc(postsRef, {
          postId: postId.trim(),
          content: content.trim(),
          createdAt: Timestamp.fromDate(new Date(dateStr.trim()))
        });
      }

      document.getElementById("bulkInput").value = "";
    };

    const q = query(postsRef, orderBy("createdAt", "asc"));
    onSnapshot(q, (snapshot) => {
      renderPosts(snapshot);
    });
  </script>

  <style>
    body { display:flex; font-family:Arial; }
    #main { width:75%; padding:20px; }
    #timeline { width:25%; padding:20px; background:#f5f5f5; }
    .post { margin-bottom:40px; }
    textarea { width:100%; height:120px; }
    button { margin-top:10px; padding:8px 12px; }
  </style>
</head>

<body>
  <div id="main">
    <h2>เพิ่มหลายโพสต์พร้อมกัน</h2>
    <p>รูปแบบ: postId | คำแปล | YYYY-MM-DD</p>
    <textarea id="bulkInput"></textarea>
    <button onclick="addPosts()">เพิ่มโพสต์</button>

    <h2>โพสต์ทั้งหมด</h2>
    <div id="posts"></div>
  </div>

  <div id="timeline">
    <h3>Timeline</h3>
  </div>
</body>
</html>
