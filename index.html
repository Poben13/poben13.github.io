<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Timeline</title>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
<script async src="https://platform.twitter.com/widgets.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  display:flex;
  background:#f5f5f5;
}

.main{
  flex:3;
  padding:20px;
}

.sidebar{
  flex:1;
  background:#fff;
  border-left:1px solid #ddd;
  padding:20px;
  height:100vh;
  overflow-y:auto;
}

textarea{
  width:100%;
  height:100px;
  margin-bottom:10px;
}

button{
  padding:8px 12px;
  margin:5px 0;
  cursor:pointer;
}

.post-group{
  background:#fff;
  padding:15px;
  margin-bottom:20px;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.05);
}

.translation{
  margin-top:10px;
  font-style:italic;
  color:#333;
}

.timeline-button{
  display:block;
  width:100%;
  margin-bottom:10px;
  padding:10px;
  background:#f0f0f0;
  border:none;
  text-align:left;
  cursor:pointer;
}

.timeline-button:hover{
  background:#ddd;
}
</style>
</head>

<body>

<div class="main">
  <h2>เพิ่มโพสต์</h2>

  <textarea id="tweetLinks" placeholder="วางลิงก์หลายโพสต์ (1 บรรทัด ต่อ 1 ลิงก์)"></textarea>
  <textarea id="translation" placeholder="คำแปล"></textarea>
  <button onclick="addPostGroup()">เพิ่มโพสต์</button>

  <hr>
  <div id="posts"></div>
</div>

<div class="sidebar">
  <h3>Timeline</h3>
  <div id="timeline"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const postsRef = collection(db,"posts");

function extractTweetId(link){
  const match = link.match(/(\d{10,})/);
  return match ? match[1] : null;
}

function getTweetDate(tweetId){
  const timestamp = (BigInt(tweetId) >> 22n) + 1288834974657n;
  return new Date(Number(timestamp));
}

async function addPostGroup(){
  const rawLinks = document.getElementById("tweetLinks").value.trim();
  const translation = document.getElementById("translation").value.trim();

  if(!rawLinks) return alert("ใส่ลิงก์ก่อน");

  const links = rawLinks.split("\n");
  const postIds = [];
  let earliestDate = null;

  links.forEach(link=>{
    const id = extractTweetId(link);
    if(id){
      postIds.push(id);
      const date = getTweetDate(id);
      if(!earliestDate || date < earliestDate){
        earliestDate = date;
      }
    }
  });

  if(postIds.length === 0) return alert("ไม่พบ Tweet ID");

  await addDoc(postsRef,{
    postIds,
    translation,
    postDate: earliestDate
  });

  document.getElementById("tweetLinks").value = "";
  document.getElementById("translation").value = "";
}

function deletePost(id){
  deleteDoc(doc(db,"posts",id));
}

function renderPosts(snapshot){
  const postsDiv = document.getElementById("posts");
  const timelineDiv = document.getElementById("timeline");

  postsDiv.innerHTML = "";
  timelineDiv.innerHTML = "";

  const monthMap = {};

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    if(!data.postIds || !data.postDate) return;

    const postDate = data.postDate.toDate();
    const month = postDate.getMonth()+1;
    const year = postDate.getFullYear();
    const key = `${month}-${year}`;

    if(!monthMap[key]) monthMap[key]=[];

    monthMap[key].push({
      id:docSnap.id,
      ...data
    });
  });

  // render posts
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    if(!data.postIds) return;

    const div = document.createElement("div");
    div.className="post-group";

    data.postIds.forEach(id=>{
      const block = document.createElement("blockquote");
      block.className="twitter-tweet";
      block.innerHTML=`<a href="https://twitter.com/x/status/${id}"></a>`;
      div.appendChild(block);
    });

    if(data.translation){
      const t = document.createElement("div");
      t.className="translation";
      t.innerText=data.translation;
      div.appendChild(t);
    }

    const del = document.createElement("button");
    del.innerText="ลบโพสต์";
    del.onclick=()=>deletePost(docSnap.id);
    div.appendChild(del);

    postsDiv.appendChild(div);
  });

  if(window.twttr) window.twttr.widgets.load();

  // render timeline
  Object.keys(monthMap).forEach(key=>{
    const [month,year]=key.split("-");
    const btn = document.createElement("button");
    btn.className="timeline-button";
    btn.innerText=`เดือนที่ ${month} ปี ${year}`;
    btn.onclick=()=>{
      postsDiv.innerHTML="";
      monthMap[key].forEach(post=>{
        const div = document.createElement("div");
        div.className="post-group";

        post.postIds.forEach(id=>{
          const block = document.createElement("blockquote");
          block.className="twitter-tweet";
          block.innerHTML=`<a href="https://twitter.com/x/status/${id}"></a>`;
          div.appendChild(block);
        });

        if(post.translation){
          const t = document.createElement("div");
          t.className="translation";
          t.innerText=post.translation;
          div.appendChild(t);
        }

        const del = document.createElement("button");
        del.innerText="ลบโพสต์";
        del.onclick=()=>deletePost(post.id);
        div.appendChild(del);

        postsDiv.appendChild(div);
      });

      if(window.twttr) window.twttr.widgets.load();
    };

    timelineDiv.appendChild(btn);
  });
}

const q = query(postsRef, orderBy("postDate","asc"));

onSnapshot(q,(snapshot)=>{
  renderPosts(snapshot);
});

</script>

</body>
</html>
