<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const ADMIN_PASSWORD = "6767";
let isAdmin = false;

const adminStatusEl = document.getElementById("adminStatus");

function updateAdminUI() {
  document.querySelectorAll('button[data-action="edit"], button[data-action="delete"]').forEach(btn => {
    btn.disabled = !isAdmin;
    btn.classList.toggle('opacity-50', !isAdmin);
    btn.classList.toggle('cursor-not-allowed', !isAdmin);
  });
}

window.checkAdmin = () => {
  const input = document.getElementById("adminCode").value.trim();
  if (input === ADMIN_PASSWORD) {
    isAdmin = true;
    adminStatusEl.textContent = "เข้าสู่ระบบสำเร็จ ✓ (แอดมิน)";
    adminStatusEl.className = "mt-3 text-center text-sm text-green-600 font-medium";
  } else {
    isAdmin = false;
    adminStatusEl.textContent = "รหัสไม่ถูกต้อง ✗";
    adminStatusEl.className = "mt-3 text-center text-sm text-red-600 font-medium";
  }
  updateAdminUI();
};

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "ikizuliveth.firebaseapp.com",
  projectId: "ikizuliveth",
  storageBucket: "ikizuliveth.firebasestorage.app",
  messagingSenderId: "435466293836",
  appId: "1:435466293836:web:15c46e9be1b484c91b9ae9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const postsRef = collection(db, "posts");

const postsContainer = document.getElementById("posts");
let allPosts = [];
let monthMap = {};

function getDateFromTweetId(postId) {
  try {
    const twitterEpoch = 1288834974657n;
    const timestamp = (BigInt(postId) >> 22n) + twitterEpoch;
    return new Date(Number(timestamp));
  } catch (e) {
    console.error("Invalid tweet ID for date:", postId);
    return new Date(); // fallback to now
  }
}

function render(posts) {
  postsContainer.innerHTML = "";
  if (posts.length === 0) {
    postsContainer.innerHTML = '<p class="text-center text-gray-500 py-10">ไม่มีโพสต์ในช่วงนี้</p>';
  }
  posts.forEach(p => createPostCard(p));
  if (window.twttr?.widgets) {
    window.twttr.widgets.load();
  } else {
    console.warn("Twitter widgets not loaded yet");
  }
  updateAdminUI();
}

function createPostCard(post) {
  const card = document.createElement("div");
  card.className = "bg-white dark:bg-gray-900 rounded-3xl shadow border border-gray-200 dark:border-gray-800 overflow-hidden card-hover";

  let tweetsHTML = (post.postIds || []).map(id => `
    <blockquote class="twitter-tweet"><a href="https://twitter.com/i/status/${id}"></a></blockquote>
  `).join("");

  card.innerHTML = `
    <div class="p-5 sm:p-7">
      ${tweetsHTML}
      <div class="flex flex-wrap gap-3 mt-7">
        <button onclick="toggleTranslate('${post.id}')" class="px-6 py-3 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 rounded-2xl font-medium btn-hover">ดูคำแปล</button>
        <button onclick="editPost('${post.id}')" data-action="edit" 
          class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-medium btn-hover ${isAdmin ? '' : 'opacity-50 cursor-not-allowed'}">แก้ไขคำแปล</button>
        <button onclick="deletePost('${post.id}')" data-action="delete" 
          class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-2xl font-medium btn-hover ${isAdmin ? '' : 'opacity-50 cursor-not-allowed'}">ลบโพสต์</button>
      </div>
      <div id="trans-${post.id}" class="hidden mt-7 pt-7 border-t text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line">
        ${post.content || "ยังไม่มีคำแปล"}
      </div>
    </div>
  `;
  postsContainer.appendChild(card);
}

window.toggleTranslate = id => {
  const el = document.getElementById("trans-" + id);
  if (el) el.classList.toggle("hidden");
};

window.deletePost = async id => {
  if (!isAdmin) return alert("ต้องเข้าสู่ระบบแอดมินก่อน");
  if (!confirm("ยืนยันลบโพสต์นี้?")) return;
  try {
    await deleteDoc(doc(db, "posts", id));
  } catch (e) {
    alert("ลบไม่ได้: " + e.message);
  }
};

window.editPost = async id => {
  if (!isAdmin) return alert("ต้องเข้าสู่ระบบแอดมินก่อน");
  const post = allPosts.find(p => p.id === id);
  if (!post) return alert("ไม่พบโพสต์");
  const newContent = prompt("แก้ไขคำแปล:", post.content || "");
  if (newContent === null) return;
  try {
    await updateDoc(doc(db, "posts", id), { content: newContent.trim() });
  } catch (e) {
    alert("อัปเดตไม่ได้: " + e.message);
  }
};

window.addPosts = async () => {
  const links = document.getElementById("linkInput").value.trim().split("\n").filter(Boolean);
  const content = document.getElementById("translateInput").value.trim();
  const postIds = links.map(l => l.match(/status\/(\d+)/)?.[1]).filter(Boolean);
  
  if (postIds.length === 0) return alert("ไม่พบลิงก์ Twitter ที่ถูกต้อง");
  
  try {
    const date = getDateFromTweetId(postIds[0]);
    await addDoc(postsRef, {
      postIds,
      content,
      createdAt: Timestamp.fromDate(date)
    });
    document.getElementById("linkInput").value = "";
    document.getElementById("translateInput").value = "";
  } catch (e) {
    alert("เพิ่มไม่ได้: " + e.message);
  }
};

window.showAll = () => render(allPosts);

const q = query(postsRef, orderBy("createdAt", "asc"));
onSnapshot(q, snapshot => {
  allPosts = [];
  monthMap = {};

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const post = { id: docSnap.id, ...data };
    allPosts.push(post);

    let d;
    if (data.createdAt && data.createdAt.toDate) {
      d = data.createdAt.toDate();
    } else {
      console.warn("Post missing createdAt:", post.id);
      d = getDateFromTweetId(post.postIds?.[0] || "0") || new Date();
    }

    const key = `${d.getMonth() + 1}-${d.getFullYear()}`;
    if (!monthMap[key]) monthMap[key] = [];
    monthMap[key].push(post);
  });

  // Render ปุ่ม timeline ทั้ง desktop และ mobile
  renderTimelineButtons(document.getElementById("timelineButtons"));
  renderTimelineButtons(document.getElementById("timelineButtonsMobile"));

  // Render โพสต์ทั้งหมดเป็น default
  render(allPosts);
}, error => {
  console.error("Firestore snapshot error:", error);
  postsContainer.innerHTML = '<p class="text-red-500 text-center py-10">เกิดข้อผิดพลาดในการโหลดข้อมูล โปรดรีเฟรชหน้า</p>';
});

function renderTimelineButtons(container) {
  if (!container) return;
  container.innerHTML = "";
  Object.keys(monthMap)
    .sort((a, b) => {
      const [mA, yA] = a.split("-").map(Number);
      const [mB, yB] = b.split("-").map(Number);
      return (yA - yB) || (mA - mB); // เก่า → ใหม่ (บนลงล่าง)
    })
    .forEach(key => {
      const [m, y] = key.split("-");
      const count = monthMap[key].length;
      const btn = document.createElement("button");
      btn.className = "w-full text-left px-5 py-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-800 transition font-medium text-lg flex justify-between items-center";
      btn.innerHTML = `<span>${y} ปี ${m} เดือน</span><span class="text-gray-500">(${count})</span>`;
      btn.onclick = () => {
        render(monthMap[key]);
        // ถ้าเป็น mobile modal ให้ปิด
        if (container.id === "timelineButtonsMobile") {
          closeTimeline();
        }
      };
      container.appendChild(btn);
    });
}

// Modal controls (คงเดิมจากโค้ดก่อนหน้า)
const modal = document.getElementById("timelineModal");
const openBtn = document.getElementById("openTimelineBtn");
const closeBtn = document.getElementById("closeTimelineBtn");

function openTimeline() { /* ... คงเดิม */ }
function closeTimeline() { /* ... คงเดิม */ }

if (openBtn) openBtn.onclick = openTimeline;
if (closeBtn) closeBtn.onclick = closeTimeline;
if (modal) modal.onclick = (e) => { if (e.target === modal) closeTimeline(); };
</script>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
